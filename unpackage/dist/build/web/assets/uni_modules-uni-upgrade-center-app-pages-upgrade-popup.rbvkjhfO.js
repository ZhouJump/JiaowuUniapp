import{E as e,m as t,M as s,x as o,h as i,V as n,s as a,k as l,W as r,c as d,w as c,i as h,o as f,a as u,f as p,t as g,b as m,F as k,z as w,X as P,A as _,u as y,K as b,Y as S,Z as F}from"./index-HXBhxmPW.js";import{_ as x}from"./bg_top.0XzFZ12Y.js";import{_ as L}from"./_plugin-vue_export-helper.BCo6x5W8.js";const v="UNI_ADMIN_UPGRADE_CENTER_LOCAL_FILE_PATH";let T,C=null;const A=L({data:()=>({installForBeforeFilePath:"",installed:!1,installing:!1,downloadSuccess:!1,downloading:!1,downLoadPercent:0,downloadedSize:0,packageFileSize:0,tempFilePath:"",title:"更新日志",contents:"",version:"",is_mandatory:!1,url:"",platform:[],store_list:null,subTitle:"发现新版本",downLoadBtnTextiOS:"立即跳转更新",downLoadBtnText:"立即下载更新",downLoadingText:"安装包下载中，请稍后"}),onLoad({local_storage_key:s}){if(!s)return console.error("local_storage_key为空，请检查后重试"),void e();const o=t(s);if(!o)return console.error("安装包信息为空，请检查后重试"),void e();const i=["version","url","type"];for(let t in o)if(-1!==i.indexOf(t)&&!o[t])return console.error(`参数 ${t} 必填，请检查后重试`),void e();Object.assign(this,o),this.checkLocalStoragePackage()},onBackPress(){if(this.is_mandatory)return!0;this.needNotificationProgress||C&&C.abort()},onHide(){T=null},computed:{isWGT(){return"wgt"===this.type},isiOS(){return!this.isWGT&&-1!==this.platform.indexOf("iOS")},isAndroid(){return-1!==this.platform.indexOf("Android")},isAppStore(){return this.isiOS||!this.isiOS&&!this.isWGT&&-1===this.url.indexOf(".apk")},needNotificationProgress(){return-1===this.platform.indexOf("iOS")&&!this.is_mandatory}},methods:{checkLocalStoragePackage(){const e=t(v);if(e){const{version:t,savedFilePath:s,installed:o}=e;o||0!==function(e="0",t="0"){e=String(e).split("."),t=String(t).split(".");const s=Math.min(e.length,t.length);let o=0;for(let i=0;i<s;i++){const s=Number(e[i]),n=Number(t[i]);if(s>n){o=1;break}if(s<n){o=-1;break}}if(0===o&&e.length!==t.length){const i=e.length>t.length,n=i?e:t;for(let e=s;e<n.length;e++)if(Number(n[e])>0){o=i?1:-1;break}}return o}(t,this.version)?this.deleteSavedFile(s):(this.downloadSuccess=!0,this.installForBeforeFilePath=s,this.tempFilePath=s)}},askAbortDownload(){s({title:"是否取消下载？",cancelText:"否",confirmText:"是",success:t=>{t.confirm&&(C&&C.abort(),cancelNotificationProgress(),e())}})},async closeUpdate(){if(this.downloading){if(this.is_mandatory)return o({title:"下载中，请稍后……",icon:"none",duration:500});if(!this.needNotificationProgress)return void this.askAbortDownload()}!this.needNotificationProgress&&this.downloadSuccess&&this.tempFilePath&&await this.saveFile(this.tempFilePath,this.version),e()},updateApp(){this.checkStoreScheme().catch((()=>{this.downloadPackage()})).finally((()=>{T=null}))},checkStoreScheme(){const e=(this.store_list||[]).filter((e=>e.enable));return e&&e.length?(e.sort(((e,t)=>t.priority-e.priority)).map((e=>e.scheme)).reduce(((e,t,s)=>(T=(e||(e=Promise.reject())).catch((()=>new Promise(((e,s)=>{plus.runtime.openURL(t,(e=>{s(e)}))})))),T)),T),T):Promise.reject()},downloadPackage(){this.downloading=!0,C=i({url:this.url,success:e=>{if(200==e.statusCode)if(this.isWGT&&"wgt"!==e.tempFilePath.split(".").slice(-1)[0]){const t=e=>{console.log("[FILE RENAME FAIL]：",JSON.stringify(e))};plus.io.resolveLocalFileSystemURL(e.tempFilePath,(e=>{e.getParent((s=>{const o=`new_wgt_${Date.now()}.wgt`;e.copyTo(s,o,(e=>{this.tempFilePath=e.fullPath,this.downLoadComplete()}),t)}),t)}),t)}else this.tempFilePath=e.tempFilePath,this.downLoadComplete()}}),C.onProgressUpdate((e=>{this.downLoadPercent=e.progress,this.downloadedSize=(e.totalBytesWritten/Math.pow(1024,2)).toFixed(2),this.packageFileSize=(e.totalBytesExpectedToWrite/Math.pow(1024,2)).toFixed(2),this.needNotificationProgress&&!this.downloadSuccess&&createNotificationProgress({title:"升级中心正在下载安装包……",content:`${this.downLoadPercent}%`,progress:this.downLoadPercent,onClick:()=>{this.askAbortDownload()}})})),this.needNotificationProgress&&e()},downLoadComplete(){if(this.downloadSuccess=!0,this.downloading=!1,this.downLoadPercent=0,this.downloadedSize=0,this.packageFileSize=0,C=null,this.needNotificationProgress)return finishNotificationProgress({title:"安装升级包",content:"下载完成"}),void this.installPackage();this.is_mandatory&&this.installPackage()},installPackage(){},restart(){this.installed=!1},saveFile:(e,t)=>new Promise(((s,o)=>{n({tempFilePath:e,success({savedFilePath:e}){a(v,{version:t,savedFilePath:e})},complete(){s()}})})),deleteSavedFile:e=>(l(v),r({filePath:e})),jumpToAppStore(){plus.runtime.openURL(this.url)}}},[["render",function(e,t,s,o,i,n){const a=_,l=y,r=h,L=b,v=S,T=F;return f(),d(r,{class:"mask flex-center"},{default:c((()=>[u(r,{class:"content botton-radius"},{default:c((()=>[u(r,{class:"content-top"},{default:c((()=>[u(a,{class:"content-top-text"},{default:c((()=>[p(g(i.title),1)])),_:1}),u(l,{class:"content-top",style:{top:"0"},width:"100%",height:"100%",src:x})])),_:1}),u(r,{class:"content-header"}),u(r,{class:"content-body"},{default:c((()=>[u(r,{class:"title"},{default:c((()=>[u(a,null,{default:c((()=>[p(g(i.subTitle),1)])),_:1}),u(a,{class:"content-body-version"},{default:c((()=>[p(g(i.version),1)])),_:1})])),_:1}),u(r,{class:"body"},{default:c((()=>[u(L,{class:"box-des-scroll","scroll-y":"true"},{default:c((()=>[u(a,{class:"box-des"},{default:c((()=>[p(g(i.contents),1)])),_:1})])),_:1})])),_:1}),u(r,{class:"footer flex-center"},{default:c((()=>[n.isAppStore?(f(),d(v,{key:0,class:"content-button",style:{border:"none",color:"#fff"},plain:"",onClick:n.jumpToAppStore},{default:c((()=>[p(g(i.downLoadBtnTextiOS),1)])),_:1},8,["onClick"])):(f(),m(k,{key:1},[i.downloadSuccess?i.downloadSuccess&&!i.installed?(f(),d(v,{key:1,class:"content-button",style:{border:"none",color:"#fff"},plain:"",loading:i.installing,disabled:i.installing,onClick:n.installPackage},{default:c((()=>[p(g(i.installing?"正在安装……":"下载完成，立即安装"),1)])),_:1},8,["loading","disabled","onClick"])):i.installed&&!n.isWGT?(f(),d(v,{key:2,class:"content-button",style:{border:"none",color:"#fff"},plain:"",loading:i.installing,disabled:i.installing,onClick:n.installPackage},{default:c((()=>[p(" 安装未完成，点击安装 ")])),_:1},8,["loading","disabled","onClick"])):i.installed&&n.isWGT?(f(),d(v,{key:3,class:"content-button",style:{border:"none",color:"#fff"},plain:"",onClick:n.restart},{default:c((()=>[p(" 安装完毕，点击重启 ")])),_:1},8,["onClick"])):w("",!0):(f(),m(k,{key:0},[i.downloading?(f(),d(r,{key:0,class:"progress-box flex-column"},{default:c((()=>[u(T,{class:"progress",percent:i.downLoadPercent,activeColor:"#5656D1","show-info":"","stroke-width":"10"},null,8,["percent"]),u(r,{style:{width:"100%","font-size":"28rpx",display:"flex","justify-content":"space-around"}},{default:c((()=>[u(a,null,{default:c((()=>[p(g(i.downLoadingText),1)])),_:1}),u(a,null,{default:c((()=>[p("("+g(i.downloadedSize)+"/"+g(i.packageFileSize)+"M)",1)])),_:1})])),_:1})])),_:1})):(f(),d(v,{key:1,class:"content-button",style:{border:"none",color:"#fff"},plain:"",onClick:n.updateApp},{default:c((()=>[p(g(i.downLoadBtnText),1)])),_:1},8,["onClick"]))],64))],64))])),_:1})])),_:1}),i.is_mandatory?w("",!0):(f(),d(l,{key:0,class:"close-img",src:"/assets/app_update_close-DKiT_s6F.png",onClick:P(n.closeUpdate,["stop"])},null,8,["onClick"]))])),_:1})])),_:1})}],["__scopeId","data-v-f00c0c59"]]);export{A as default};
